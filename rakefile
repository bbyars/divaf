require 'less' # sudo gem install less
require 'erb'

task :default => [:compile]

task :compile => [:compile_html, :compile_css]

task :compile_html do
  layout = File.open("partials/layout.rhtml", "r").read
  process("*.rhtml", ".html") do |template|
    content = ERB.new(template).result(binding)
    ERB.new(layout).result(binding)
  end
end

task :compile_css do
  process("stylesheets/*.less", ".css") { |less| Less::Engine.new(less).to_css }
end

def process(template_path, compiled_extension, &block)
  FileList[template_path].each do |filename|
    old_extension = File.extname(filename)
    new_path = "public/" + filename.sub(/#{Regexp.quote(old_extension)}/, compiled_extension)
    puts "#{filename} => #{new_path}"
    compiled = yield(File.open(filename, 'r').read)
    File.open(new_path, 'w') { |f| f.write(compiled) }
  end
end

# Used for erb templates
def css(filename)
  '<link href="stylesheets/#{filename}.css" rel="stylesheet" type="text/css" />'
end
